---
title: "Comparing logistic curves"
author: "G. W. Stagg"
output: rmarkdown::html_vignette
---
<!--
%\VignetteEngine{knitr::rmarkdown}
%\VignetteIndexEntry{Comparing logistic curves}
-->
```{r, echo=FALSE, results="hide"}
library(voltagefit)
library(doParallel)
registerDoParallel(1)
```

##Introduction
This is a comparison of fitting different sigmoid curves to wafer devices in `voltagefit`. In this document I have left the default fitting method of least squares, which is minimised using `optim`, at writing *without* using derivatives.

##Original curve
The original 6-parameter curve that was being used is,
$$y = \theta_1 + \frac{\theta_2}{1 + \exp(\theta_3 + \theta_4 x + \theta_5 x^2 + \theta_6 x^3)}.$$
Here the effect of changing \(\theta_1\) and \(\theta_2\) can probably be deduced, but the effect of varying \(\theta_3\) to \(\theta_6\) may be harder to pinpoint.

###Results
The resulting output from fitting this model to the devices on `wafer3737` is:
```{r,fig.width = 8, fig.height = 8}
fit_wafer(wafer3737,cost_func=sum_residuals, dev_curve=curve_exp_poly, 
          initparams = c(-9.1123, -15.5432, 1.1966,0.6834, -0.1843, 0.1418),
          plot=TRUE,verbose=FALSE)
```

------------------------------------------------------------------------

##tanh curve
$$y = \theta_1 + \theta_2 \tanh(\frac{x-\theta_4}{\theta_3})$$

###Parameter meaning

  * \(\theta_1\) = value of y at center of the curve
  * \(\theta_2\) = distance from the center of the curve to the top/bottom
  * \(\theta_3\) = a measure of the steepness of the curve
  * \(\theta_4\) = x shift

###Results
The resulting output from fitting this model to the devices on `wafer3737` is:
```{r,fig.width = 8, fig.height = 8}
fit_wafer(wafer3737,cost_func=sum_residuals, dev_curve=curve_tanh, 
          initparams = c(-10,10,0.5,0),plot=TRUE,verbose=FALSE)
```

------------------------------------------------------------------------

##Four Parameter Logistic Curve
*NOTE: Here I have shifted the data >> 0, the raw curve is not supposed to handle x values of less than zero.*
$$ y = \theta_4 + \frac{\theta_1-\theta_4}{1+((x+100)/\theta_3)^{\theta_2}}$$

###Parameter meaning

  * \(\theta_1\) = the minimum value
  * \(\theta_2\) = a measure of the steepness of the curve
  * \(\theta_3\) = the point of inflection(+100)
  * \(\theta_4\) = the maximum value
  
###Results
The resulting output from fitting this model to the devices on `wafer3737` is:
```{r,fig.width = 8, fig.height = 8}
fit_wafer(wafer3737,cost_func=sum_residuals, dev_curve=curve_4PL, 
          initparams = c(-30,5,100,-10),plot=TRUE,verbose=FALSE)
```

------------------------------------------------------------------------

##Four Parameter BARO Curve (4BARO)
$$y=\theta_1 +\frac{\theta_2}{1+\exp(\theta_3(x-\theta_4))}$$

###Parameter meaning

  * \(\theta_1\) = the minimum value
  * \(\theta_2\) = the range of response. Note: (P1+P2) gives the minimum value
  * \(\theta_3\) = a measure of the steepness of the curve
  * \(\theta_4\) = x shift
  
###Results
The resulting output from fitting this model to the devices on `wafer3737` is:
```{r,fig.width = 8, fig.height = 8}
fit_wafer(wafer3737,cost_func=sum_residuals, dev_curve=curve_4BARO, 
          initparams = c(-10,-30,5,0),plot=TRUE,verbose=FALSE)
```

------------------------------------------------------------------------

##Five Parameter BARO Curve (5BARO)
  $$c = \frac{2\theta_3\theta_5}{|\theta_3+\theta_5|}$$
  $$f = \frac{1}{1+\exp(-c(x-\theta_4))}$$
  $$y = \theta_1 + \frac{\theta_2}{1 + f\exp(\theta_3(x-\theta_4)) + (1-f)\exp(\theta_5(x-\theta_4))}$$

###Parameter meaning

  * \(\theta_1\) = the maximum value
  * \(\theta_2\) = the minimum value
  * \(\theta_3\) = a measure of the steepness of the curve
  * \(\theta_4\) = x shift
  * \(\theta_5\) = a measure of curve asymmetry
  
###Results
The resulting output from fitting this model to the devices on `wafer3737` is:
```{r,fig.width = 8, fig.height = 8}
fit_wafer(wafer3737,cost_func=sum_residuals, dev_curve=curve_5BARO, 
          initparams = c(-10,-30,5,0,5),plot=TRUE,verbose=FALSE)
```

------------------------------------------------------------------------

##Least Area Fitting
The voltage x values in the forward curves are unevenly distributed, so least squares emphasises the fit in high density areas. A solution is to instead of minimising the residuals, minimise the area between the model curve and the curve created by the data points.

This can be derived by writing down an integral of the difference between two curves (one curve going through the data points, one going through the fitted points), giving the area between the two curves. Now discretise the data and model curve using linear interpolation. This results in an integral that can be approximated in a similar way to the trapezium rule. The residual area between point \(x[n]\) and \(x[n+1]\) is then,

$$A_n = \frac{1}{2} (x_{n+1} - x_{n}) (y_n-z_n+y_{n+1}-z_{n+1}),$$

where $y_n$ is the data points and $z_n$ takes the value of the fitted curve for all $x_n$. The cost is then defined as,

$$C = \Sigma_{n=1}^N A_n.$$

```{r,fig.width = 8, fig.height = 8}
fit_wafer(wafer3737,cost_func=area_between_curves, dev_curve=curve_5BARO, 
          initparams = c(-10,-30,5,0,5),plot=TRUE,verbose=FALSE)
```
